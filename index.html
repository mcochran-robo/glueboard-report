<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Glueboard Report</title>
    <style>
      body { font-family: system-ui, sans-serif; max-width: 980px; margin: 24px auto; padding: 0 14px; }
      h1 { margin: 0 0 6px; }
      .sub { color:#666; margin: 0 0 18px; }
      input, button { font-size: 16px; padding: 10px; }
      input { width: 100%; box-sizing: border-box; margin: 8px 0 12px; }
      button { cursor: pointer; }
      .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-top: 14px; }
      .card { border: 1px solid #e6e6e6; border-radius: 12px; padding: 14px; background: #fff; }
      .big { font-size: 56px; font-weight: 800; line-height: 1; letter-spacing: -0.02em; }
      .label { color:#666; margin-top: 6px; font-size: 14px; }
      .warn { border: 2px solid #c62828; background:#ffebee; }
      .ok { border: 2px solid #2e7d32; background:#e8f5e9; }
      .warn-title { font-weight: 800; color:#b71c1c; margin:0 0 6px; }
      .ok-title { font-weight: 800; color:#1b5e20; margin:0 0 6px; }
      ul { margin: 8px 0 0 18px; }
      pre { background:#f6f6f6; padding: 12px; overflow:auto; border-radius: 10px; }
      .row { display:flex; gap: 10px; align-items:center; flex-wrap: wrap; }
      .muted { color:#666; font-size: 13px; }
      .hidden { display:none; }
      @media (max-width: 760px) { .grid { grid-template-columns: 1fr; } .big { font-size: 46px; } }
    </style>
  </head>
  <body>
    <h1>Glueboard Report</h1>
    <p class="sub">Paste an image URL, run the workflow, and view a summarized report.</p>

    <input id="imageFile" type="file" accept="image/*" capture="environment" />
    <div class="row">
      <button id="run">Run Analysis</button>
      <span id="status" class="muted"></span>
    </div>

    <div class="grid">
      <div class="card" id="coverageCard">
        <div class="big" id="coveragePct">—%</div>
        <div class="label">Glueboard coverage</div>
        <div class="muted" id="coverageNote"></div>
      </div>

      <div class="card" id="iocCard">
        <div id="iocState">
          <div class="warn-title">⚠️ Insects of Concern Detected</div>
          <div class="muted">Total matches across all segments:</div>
          <div class="big" id="iocCount">0</div>
        </div>

        <div id="iocListWrap" class="hidden">
          <div class="label">Insects of concern (unique)</div>
          <ul id="iocList"></ul>
        </div>
      </div>
    </div>

    <details style="margin-top:14px;">
      <summary>Raw workflow response</summary>
      <pre id="raw">{}</pre>
    </details>

  <script>
  // ---------- Utilities ----------
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function uniqPreserveOrder(arr) {
    const seen = new Set();
    return arr.filter(x => x && !seen.has(x) && seen.add(x));
  }

  // Show JS errors on-page (critical for GitHub Pages)
  window.addEventListener("error", (e) => {
    const statusEl = document.getElementById("status");
    const rawEl = document.getElementById("raw");
    if (statusEl) statusEl.textContent = "JS error: " + e.message;
    if (rawEl) rawEl.textContent = e.error?.stack || String(e.message);
  });

  // ---------- Config ----------
  const WORKFLOW_URL =
    "https://serverless.roboflow.com/vision-project-0y4uc/workflows/sam3-with-prompts-2";
  const API_KEY = "Y7AWCmC4VdWbClU92tVw";
  const PROMPTS = ["glueboard","insects","fly","gnat","bug","Beetle","moth"];

  // ---------- UI helpers ----------
  function setCoverage(pct) {
    const el = document.getElementById("coveragePct");
    if (typeof pct === "number" && isFinite(pct)) {
      el.textContent = pct.toFixed(1) + "%";
    } else {
      el.textContent = "—%";
    }
  }

  function setIOC(count, names) {
    const card = document.getElementById("iocCard");
    const countEl = document.getElementById("iocCount");
    const listWrap = document.getElementById("iocListWrap");
    const listEl = document.getElementById("iocList");
    const titleEl = document.querySelector("#iocState > div:first-child");

    if (count === "—") {
      countEl.textContent = "—";
      titleEl.textContent = "Running analysis…";
      titleEl.className = "muted";
      card.classList.remove("ok","warn");
      listWrap.classList.add("hidden");
      return;
    }

    countEl.textContent = count;

    if (count > 0) {
      card.classList.add("warn");
      card.classList.remove("ok");
      titleEl.textContent = "⚠️ Insects of Concern Detected";
      titleEl.className = "warn-title";
    } else {
      card.classList.add("ok");
      card.classList.remove("warn");
      titleEl.textContent = "✅ No Insects of Concern";
      titleEl.className = "ok-title";
    }

    listEl.innerHTML = "";
    if (names.length > 0) {
      listWrap.classList.remove("hidden");
      names.forEach(n => {
        const li = document.createElement("li");
        li.textContent = n;
        listEl.appendChild(li);
      });
    } else {
      listWrap.classList.add("hidden");
    }
  }

  // ---------- Main ----------
  window.addEventListener("DOMContentLoaded", () => {
    const runBtn = document.getElementById("run");
    const statusEl = document.getElementById("status");
    const rawEl = document.getElementById("raw");

    runBtn.onclick = async () => {
      statusEl.textContent = "Starting…";
      rawEl.textContent = "{}";
      setCoverage(undefined);
      setIOC("—", []);

      const file = document.getElementById("imageFile")?.files?.[0];
      if (!file) {
        statusEl.textContent = "Please select or take a photo.";
        return;
      }

      try {
        statusEl.textContent = "Uploading image…";
        const base64 = await fileToBase64(file);

        statusEl.textContent = "Running workflow…";
        const resp = await fetch(WORKFLOW_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            api_key: API_KEY,
            inputs: {
              image: { type: "base64", value: base64 },
              prompts: PROMPTS
            }
          })
        });

        const result = await resp.json();
        rawEl.textContent = JSON.stringify(result, null, 2);

        // -------- Parse YOUR workflow output --------
        const out = Array.isArray(result.outputs)
          ? result.outputs[0]
          : result.outputs;

        // Coverage
        setCoverage(out?.["Coverage Percent"]);

        // Insects of concern aggregation
        const rows = out?.summarize_insect_of_concern_responses || [];
        let total = 0;
        let names = [];

        rows.forEach(r => {
          total += Number(r.insects_of_concern_count || 0);
          if (Array.isArray(r.insects_of_concern)) {
            names.push(...r.insects_of_concern);
          }
        });

        setIOC(total, uniqPreserveOrder(names));

        statusEl.textContent = "Done.";
      } catch (err) {
        statusEl.textContent = "Failed — see details below.";
        rawEl.textContent = err?.stack || String(err);
      }
    };
  });
</script>


  </body>
</html>
